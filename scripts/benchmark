#!/usr/bin/env node
/*jshint node:true*/
/*globals console:true */
'use strict';

var Benchmark = require('benchmark')
  , luaparse = require('../')
  , fs = require('fs')
  , path = require('path')
  , files = process.argv.slice(2)
  , suites = {}
  , suite = new Benchmark.Suite()
  , results = []
  , verbose = false
  , minSamples = 5
  , minTime = 0;

if (!files.length) {
  console.log("Usage:\n\tbenchmark [snippet|file]...");
  console.log("Flags:\n\t-v|--verbose\n\t--samples=\n\t--minTime=");
  process.exit(1);
}

files.forEach(function(file) {
  if (/^-v|--verbose/.test(file)) return verbose = true;
  if (/^--samples=/.test(file)) {
    minSamples = file.replace(/^--samples=/, '');
    return;
  }
  if (/^--minTime=/.test(file)) {
    minTime = file.replace(/^--minTime=/, '');
    return;
  }

  if (!fs.existsSync(file)) suites[path.basename(file)] = file;
  else suites[file] = fs.readFileSync(file, 'utf-8');
});

function insertBenchmark(file, source) {
  suite.add(file, function() {
    luaparse.parse(source);
  }, { minSamples: minSamples, minTime: minTime });
}

Object.keys(suites).forEach(function(file) {
  insertBenchmark(file, suites[file]);
});

suite.on('cycle', function(event) {
  var stats = event.target.stats
    , mean = (stats.mean * 1000).toFixed(4)
    , variance = (stats.variance * 1000 * 1000).toFixed(4);
  if (verbose) console.log(String(event.target) + ' (' + mean + 'ms)');
  else console.log(mean + '\t' + variance);
});
suite.run();

/* vim: set sw=2 ts=2 et tw=80 ft=javascript : */
